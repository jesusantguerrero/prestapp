import{l as j,P as v,r as C,m as b,c as V,w as r,C as z,o as g,b as l,a as c,u as s,t as k,h as $,f as L,j as T,F as G,a3 as w,M as B}from"./app-e7293397.js";import{k as E,z as I}from"./atmosphere-ui-86b7f8ed.js";import{_ as M}from"./BaseSelect.vue_vue_type_style_index_1_lang-cbd59430.js";import{_ as q}from"./BaseTable.vue_vue_type_style_index_0_lang-efd97e4a.js";import{_ as A}from"./AppLayout.vue_vue_type_style_index_0_lang-96d4f03f.js";import{_ as H}from"./PropertySectionNav.vue_vue_type_script_setup_true_lang-516e104c.js";import{_ as D}from"./AppButton.vue_vue_type_script_setup_true_lang-046c4e1c.js";import{_ as J}from"./InvoiceCard.vue_vue_type_script_setup_true_lang-26337e5b.js";import"./customCell-f0a6687f.js";import"./close-f1b40d6b.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./PaymentFormModal.vue_vue_type_script_setup_true_lang-dd64f8b8.js";import"./PaymentGrid-6607ced0.js";import"./mathHelper-95aa3a2b.js";import"./exact-math.node-9a256fc0.js";import"./constants-0a903a05.js";import"./AccountSelect.vue_vue_type_script_setup_true_lang-cb870c82.js";import"./formatMoney-b7ef7683.js";import"./AppFormField.vue_vue_type_style_index_0_lang-d6998fd8.js";import"./index-c251e33c.js";import"./index-81f33ca2.js";import"./Modal.vue_vue_type_script_setup_true_lang-53b90f8d.js";import"./InvoiceFormModal.vue_vue_type_script_setup_true_lang-88bfc502.js";import"./user-outline-dcfa7b13.js";import"./ClientFormModal.vue_vue_type_script_setup_true_lang-d0093e27.js";import"./ClientForm.vue_vue_type_script_setup_true_lang-f1abe81a.js";import"./SectionNav.vue_vue_type_script_setup_true_lang-e0dfad64.js";import"./constants-22f9a1fe.js";import"./usePaymentModal-ad844d5c.js";import"./FastAccessOptions.vue_vue_type_script_setup_true_lang-1fc13d45.js";import"./menus-f4817d1f.js";import"./index-9dc2d84c.js";import"./index-3624ec38.js";import"./constants-7016751c.js";const K={class:"py-10 mx-auto sm:px-6 lg:px-8"},O={class:"rounded-md bg-base-lvl-3"},Q={class:"flex space-x-4 w-full px-4"},W={class:"px-4"},X={class:"items-center space-x-2 d-flex"},Y={class:"w-full flex justify-end space-x-4 pb-4 px-4"},Z={class:"px-4"},Re=j({__name:"DepositRefund",props:{category:null,client:null,refunds:null},setup(y){const _=y,t=v({client:_.client,account:null,payments:[]}),m=C([]);b(()=>t.client,async()=>{t.client&&(m.value=await h(t.client.id,_.category),t.account=m.value.length?m.value[0]:null)},{immediate:!0});function h(e,n){return w.get(`/categories/${n}/clients/${e}/balance?exclude_credits=true`).then(({data:o})=>o)}const f=C([]),F=e=>e.reduce((n,o)=>(o!=null&&o.transactionable&&n.push(...o.transactionable.payments.map(a=>{var i;return{...a,rent_id:o.transactionable.invoiceable_id,client:t.client,balance:((i=t.account)==null?void 0:i.balance)??0,payment:0}})),n),[]),N=(e,n)=>w.get("/api/transaction-lines",{params:{limit:10,page:1,filter:{account_id:n,payee_id:e},relationships:"transaction.transactionable.payments"}}).then(({data:o})=>o.data.map(a=>a.transaction));b(()=>t.account,async()=>{var e,n;if(t.client&&t.account){const o=await N((e=t.client)==null?void 0:e.id,(n=t.account)==null?void 0:n.id);f.value=F(o)}});const P=()=>{},R=e=>`${e.name} (Balance: $${Math.abs(e.balance)})`,p=v({}),U=()=>{var a,i,x;const e=(a=f.value)==null?void 0:a.reduce((u,d)=>(d.payment&&u.push({id:d.id,rent_id:d.rent_id,amount:d.payment,original_amount:d.amount}),u),[]);if(!e.length){B({type:"error",message:"Seleccione al menos un pago",title:"Error de pago"});return}const n=e[0].rent_id,o={client_id:(i=t.client)==null?void 0:i.id,account_id:(x=t.account)==null?void 0:x.id,rent_id:n,payments:e,total:e.reduce((u,d)=>u+parseFloat(d.amount),0)};p.transform(()=>({...o})).post(`/properties/${n}/transactions/refund`,{async onSuccess(){B({type:"success",message:"Reembolso de deposito creado y pagado correctamente",title:"Reembolso creado"}),m.value=await h(t.client.id,_.category),t.account=m.value.length?m.value[0]:null}})};b(p.errors,e=>{displayErrors(e)});const S=[{name:"id",label:"Pago #"},{name:"client.display_name",label:"Cliente"},{name:"method_name",label:"Metodo de pago"},{name:"balance",label:"Balance",render(e){return Math.abs(e.balance)}},{name:"payment",label:"Monto de reembolso"}];return(e,n)=>{const o=z("ElCheckbox");return g(),V(A,{title:"Rembolso de depositos"},{header:r(()=>[l(H)]),default:r(()=>[c("main",K,[c("section",O,[c("header",Q,[l(s(E),{label:"Cliente",class:"w-full"},{default:r(()=>[l(M,{modelValue:s(t).client,"onUpdate:modelValue":n[0]||(n[0]=a=>s(t).client=a),endpoint:"/api/clients",placeholder:"selecciona un cliente",label:"display_name","track-by":"id"},null,8,["modelValue"])]),_:1}),l(s(E),{label:"Categoria",class:"w-full"},{default:r(()=>[l(M,{modelValue:s(t).account,"onUpdate:modelValue":n[1]||(n[1]=a=>s(t).account=a),"track-by":e.id,options:m.value,"hide-selected":!1,"custom-label":R,placeholder:"selecciona una categoria"},null,8,["modelValue","track-by","options"])]),_:1})]),c("article",W,[l(q,{cols:S,"table-data":f.value},{id:r(({scope:{row:a}})=>[c("div",X,[l(o,{onChange:i=>P(i,a)},null,8,["onChange"]),c("span",null,k(a.concept)+" #"+k(a.id),1)])]),payment:r(({scope:{row:a}})=>[l(s(I),{class:"rounded-md shadow-none border-body-1/10",modelValue:a.payment,"onUpdate:modelValue":i=>a.payment=i,"number-format":!0},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["table-data"])]),c("footer",Y,[l(D,{disabled:s(p).processing,variant:"neutral"},{default:r(()=>[$(" Cancel")]),_:1},8,["disabled"]),l(D,{onClick:U,processing:s(p).processing,disabled:s(p).processing,variant:"secondary"},{default:r(()=>[$(" Guardar y Pagar")]),_:1},8,["processing","disabled"])]),c("article",Z,[(g(!0),L(G,null,T(y.refunds,a=>(g(),V(J,{invoice:a,key:a.id},null,8,["invoice"]))),128))])])])]),_:1})}}});export{Re as default};
